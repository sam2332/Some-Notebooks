<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <title>Topic with GPT</title>
    <!-- Include Bootstrap 3 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
    <!-- Custom styles for the topic interface -->
    <style> 

        .markdown-body table th, .markdown-body table td {
            padding: 6px 13px;
            border: 1px solid #d0d7de;
        }

        .markdown-body table th {
          font-weight: 600;
        }

        .markdown-body table th,
        .markdown-body table td {
          padding: 6px 13px;
          border: 1px solid #d0d7de;
        }

        .markdown-body table tr {
          background-color: #ffffff;
          border-top: 1px solid hsla(210,18%,87%,1);
        }

        .markdown-body table tr:nth-child(2n) {
          background-color: #f6f8fa;
        }

        .markdown-body table img {
          background-color: transparent;
        }


        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Prevent horizontal scrolling */
        }
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 250px;
            padding: 20px;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        .sidebar.active {
            transform: translateX(0);
        }
        .sidebar-toggle {
            position: absolute;
            top: 10px;
            left: 10px;
            cursor: pointer;
        }
        #main-content {
            transition: transform 0.3s ease-in-out;
        }
        #main-content.slide {
            transform: translateX(250px); /* Slide the content by the width of the sidebar */
            max-width: calc(100vw - 250px);
        }
        .textarea-container {
            position: relative;
        }
        .custom-textarea {
            width: 100%;
            height: 350px;
            resize: vertical;
        }
        .float-button a{
            color: white;
            padding-right:2px;
            padding-left:2px;
        }
        .float-button {
            position: absolute;
            top: -30px;
            right: 14px;
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 12px 12px 0 0;
        }
        #topicNamesList > li{
            list-style: none;
            text-decoration: underline;
            margin-bottom: 5px;
            cursor:pointer;
        }
        .wrapper {
            display: flex;
        }
        .sidebar {
            flex: 1;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            margin-right: 10px;
            max-width: 236px;
        }
        .topic-container {
            flex: 2;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .topic-area {
            height: calc(100vh - 100px);
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 0px;
            margin-bottom: 10px;
        }
        .topic-container {
            position: relative;
            padding: 20px;
            height: 100vh; /* Set topic container height to 100% of viewport height */
            box-sizing: border-box; /* Include padding in the total height */
        }
        .topic-area {
            overflow-y: auto;
            margin-bottom: 10px;
            border: 1px solid #ccc;
        }
        .system-message {
            text-align: left;
            margin-bottom: 10px;
            padding:5px;
            background-color: khaki;
        }
        .user-message {
            text-align: right;
            margin-bottom: 5px;
        }
        .gpt-response {
            text-align: left;
            margin-bottom: 5px;
            padding-left:5px;
            background-color: bisque;
        }
        .delete-btn {
            cursor: pointer;
            color: red;
        }
    </style>
</head>
<body>   
 <div class="wrapper">
        <!-- Sidebar with topic names -->
        <div class="sidebar active" id='sidebar'>
            <h4>
                Topics 
                <button class="plus-button btn btn-sm btn-secondary pull-right" data-toggle="modal" data-target="#createTopicModal">+</button>
            </h4>
            <ul id="topicNamesList" class='mt-3'></ul>
            <!-- Input field for Topic name -->
            <hr>
        </div>
        <!-- Topic area and input field for user message -->
        <div class="topic-container slide" id="main-content">
        <i class="fa fa-bars hamburger" id="sidebarToggle"></i>
        <span id='billingTotal'></span>


        
        <!-- Topic area and input field for user message -->
        <div class="topic-area" id="topicArea"></div>
        <form id="topicForm" style="display:none;" >
            <div class="input-group">
                <span class="input-group-btn">
                    <button type="button" class="btn btn-secondary" id='microphone'><i class="fa fa-microphone" style="color:red"></i></button>
                </span>
                <input type="text" class="form-control" id="userInput" autocomplete="off" placeholder="Type your message here...">
                <span class="input-group-btn">
                    <input class="btn btn-primary" type="submit" value="Send"/>
                </span>
            </div>
        </form>
    </div>
</div>
<div class="modal fade" id="manageTopicModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">Manage Topic</h4>
            </div>
            <div class="modal-body">
                <form id="roomForm" onkeydown="return event.key != 'Enter';">
                    <div class="form-group">
                        <label for="roomName">Topic Name</label>
                        <input type="text" class="form-control" id="roomName" placeholder="Enter Topic name...">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="renameRoomBtn">Rename</button>
                <button type="button" class="btn btn-danger" id="deleteRoomBtn">Delete</button>
            </div>
        </div>
    </div>
</div>



    
    <!-- Modal for creating a new Topic -->
<div class="modal fade" id="createTopicModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">Create Topic</h4>
            </div>
            <div class="modal-body">
                <form id="roomForm" >
                    <div class="form-group">
                        <label for="create_roomName">Topic Name</label>
                        <input type="text" class="form-control" id="create_roomName" placeholder="Enter Topic name..." onkeydown="return event.key != 'Enter';">
                    </div>
                    <div class="form-group">
                        <label for="roomName">Topic System Prompt Template</label>
                        <div class="textarea-container">
                            <textarea  class="form-control custom-textarea" id="create_roomSystemMsg"></textarea>
                            <div class="float-button">
                                <a  data-toggle="modal" data-target="#SystemTemplateModal">Load Template</a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="Create">Create</button>
            </div>
        </div>
    </div>
</div>

    <!-- Modal for displaying the dropdown with folder contents -->
<div class="modal fade" id="SystemTemplateModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">Select File</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="fileDropdown">Select a file:</label>
                    <select class="form-control" id="fileDropdown">
                        <!-- Options will be populated using JavaScript/jQuery -->
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id='selectFileBtn'>Select</button>
            </div>
        </div>
    </div>
</div>

 <!-- Modal for filling in the placeholders -->
<div class="modal fade" id="templateModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">Fill in the Blanks</h4>
            </div>
            <div class="modal-body">
                <form id="templateForm">
                    <!-- Form fields will be dynamically generated here -->
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="template_submitBtn">Submit</button>
            </div>
        </div>
    </div>
</div>

    <!-- Modal with spinner -->
    <div class="modal" tabindex="-1" role="dialog" id="spinnerModal" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p>Loading...</p>
                </div>
            </div>
        </div>
    </div>



<script>


    marked.setOptions({ sanitize: true})

    var currentRoom = null;
    var roomToManage = null;
    
    function formatCurrency(value, currencyCode) {
      // Create a NumberFormat object with currency formatting options
      const formatter = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: currencyCode
      });
      // Format the value as currency
      return formatter.format(value);
    }
    function updateTopicNames() {
        $.get('/get_topic_names', function(data) {
            if (data.success) {
                $('#topicNamesList').empty();
                data.topic_names.forEach(function(topicName) {
                    var listItem = $('<li>').text(topicName);
                    listItem.on('click', function() {
                        currentRoom = topicName;
                        
                        updateBillingTotal()
                        updateTopicHistory();  // Fetch and update topic history for the selected room
                        $('#topicForm').show();
                    });

                     listItem.on('contextmenu', function(event) {
                        event.preventDefault();  // Prevent the default context menu from appearing
                        roomToManage = topicName;  // Store the Topic to be renamed
                        $('#roomName').val(roomToManage);

                        $('#manageTopicModal').modal('show');  // Show the rename modal
                    });
                    $('#topicNamesList').append(listItem);
                });
            }
        });
    }

    // Function to fetch and update topic history for the current room
    function updateTopicHistory() {
        if (currentRoom) {
            $.get('/get_topic_info', {room_name: currentRoom}, function(data) {
                $('#topicArea').empty();
                if (data.success) {
                    data.topic_history.messages.forEach(function(message) {
                        var messageElem;
                        if (message.user) {
                            messageElem = '<div class="user-message" id="' + message.id + '"><strong>You:</strong>  <span class="delete-btn pull-right" data-message-id="' + message.id + '">[Delete]</span> <br><div class="markdown-body">' + marked.parse(message.user)+ '</div></div>';
                        } else if (message.gpt) {
                            messageElem = ' <div class="gpt-response" id="' + message.id + '"><strong class="pull-left">GPT:</strong><span class="delete-btn pull-left" style="margin-left:15px;" data-message-id="' + message.id + '">[Delete]</span><br><div class="markdown-body"> ' + marked.parse(message.gpt) + '</div></div>';
                        }else if (message.system) {
                            messageElem = '<div class="system-message" id="' + message.id + '"><strong>System:</strong> <br><div class="markdown-body">' + marked.parse(message.system)+"</div></div>";
                        }
                        $('#topicArea').append(messageElem);
                    });
                }
            });
        }
    }


    function updateBillingTotal() {
        // Send a request to the Flask route to get the billing total
        $.get('/get_billing_total', {room_name: window.currentRoom}, function(response) {
            if (response.success) {
                
                // If successful, update the HTML element with the specified ID
                $('#billingTotal').text('Running Total : ' +response.billing_total );
            } else {
                // If there is an error, display an error message
                $('#billingTotal').text('Error retrieving billing total: ' + response.message);
            }
        }).fail(function() {
            // Handle network errors
            $('#billingTotal').text('Network error while retrieving billing total.');
        });
    }

    // Example usage: update the element with the ID "billingTotal"
    updateBillingTotal();
 const templateRegex = /\{\{\s*(\w+)\s*\}\}/g;

    $(document).ready(function() {
        updateTopicNames();




$('#Create').on('click', function() {
    const templateString = $('#create_roomSystemMsg').val();
    var roomName = $('#create_roomName').val();

    $('#spinnerModal').modal('show');
    if (roomName) {
        $.post('/create_topic', {room_name: roomName,roomSystemMsg:templateString}, function(data) {
            if (data.success) {
                // Topic created successfully
                // Perform any desired actions (e.g., show a success message, redirect to Topic)
                updateTopicNames()
                // Close the modal
                $('#createTopicModal').modal('hide');
                // Clear the input field
                $('#create_roomName').val('');
                $('#create_roomSystemMsg').val('');
                currentRoom = roomName;
                updateTopicHistory(); 
                updateBillingTotal();
                $('#topicForm').show();

                $('#spinnerModal').modal('hide');
            } else {
                // Topic creation failed
                // Show an error message
                alert(data.message);
            }
        });
    } else {
        // Topic name is empty
        // Show an error message
        alert('Please enter a Topic name.');
    }
    $('#templateModal').modal('hide');
});

        



  $('#template_submitBtn').on('click', function() {
        const templateString = $('#create_roomSystemMsg').val();
        // Get filled-in values from the form
        const values = {};
        $('#templateForm .form-control').each(function() {
            const fieldId = $(this).attr('id');
            const fieldValue = $(this).val();
            values[fieldId] = fieldValue;
        });

        // Replace placeholders with values in the template string
        const resultString = templateString.replace(templateRegex, (match, placeholder) => {
            return values[placeholder] || match;
        });

        // Display the result and close the modal


        $('#create_roomSystemMsg').val(resultString);
        $('#templateModal').modal('hide');
    });

     $('#sidebarToggle').on('click', function() {
                // Toggle the 'active' class on the sidebar
                $('#sidebar').toggleClass('active');
                // Toggle the 'slide' class on the main content
                $('#main-content').toggleClass('slide');
            });
        $('#archiveBtn').on('click', function() {
            var folderPath = $('#folderPath').val();
            if (folderPath) {
                // Send request to server to archive topics
                $.post('/archive_topics', {folder_path: folderPath}, function(data) {
                    if (data.success) {
                        // Successfully archived topics
                        alert(data.message);
                        $('#archiveModal').modal('hide');
                    } else {
                        // Failed to archive topics
                        alert(data.message);
                    }
                });
            } else {
                alert('Please enter a folder path.');
            }
        });


        $('#SystemTemplateModal').on('show.bs.modal', function() {
                // Request folder contents from the Python back-end
                $.get('/get_folder_contents', function(data) {
                    if (data.success) {
                        // Populate the dropdown options
                        var fileDropdown = $('#fileDropdown');
                        fileDropdown.empty();
                        data.folder_contents.forEach(function(file) {
                            fileDropdown.append('<option value="' + file + '">' + file + '</option>');
                        });
                    } else {
                        alert(data.message);
                    }
                });
            });
 // Load the file content and set it to the textarea
        $('#selectFileBtn').on('click', function() {
            // Get the selected filename from the dropdown
            var selectedFile = $('#fileDropdown').val();
            if (selectedFile) {
                // Request file content from the Python back-end
                $.get('/get_file_content', {filename: selectedFile}, function(data) {
                    if (data.success) {

                        
                        // Set the file content to the textarea with ID 'create_roomSystemMsg'
                        const templateString = data.file_content
                        $('#create_roomSystemMsg').val(templateString);
                        const matches = [...templateString.matchAll(templateRegex)];
                        if (matches.length !== 0) {
                            

                            // Deduplicate placeholders using a Set
                            const uniquePlaceholders = new Set(matches.map(match => match[1]));

                            // Generate form fields for each unique placeholder
                            const templateForm = $('#templateForm');
                            templateForm.empty();
                            uniquePlaceholders.forEach(placeholder => {
                                const field = `
                                    <div class="form-group">
                                        <label for="${placeholder}">${placeholder}</label>
                                        <input type="text" class="form-control" id="${placeholder}" placeholder="${placeholder}">
                                    </div>
                                `;
                                templateForm.append(field);
                            });

                            // Show the modal
                            $('#templateModal').modal('show');

                        }

                        // Close the modal
                        $('#SystemTemplateModal').modal('hide');
                    } else {
                        alert(data.message);
                    }
                });
            } else {
                alert('Please select a file.');
            }
        });
        // Delete a Topic
        $('#deleteRoomBtn').on('click', function() {
            $.post('/delete_topic', {room_name: window.roomToManage}, function(data) {
                if (data.success) {
                    // Topic deleted successfully
                    // Perform any desired actions
                    alert(data.message);
                    updateTopicNames()
                    $('#manageTopicModal').modal('hide');
                    $('#roomName').val('');
                    $('#topicForm').hide();
                    if (window.roomToManage == window.currentRoom ){
                        $("#topicArea").empty()
                    }
                } else {
                    // Topic deletion failed
                    alert(data.message);
                }
            });
        });
        $("#renameRoomBtn").click(function(){
            event.preventDefault();
            var newTopicRoomName = $('#roomName').val();
            if (newTopicRoomName) {
                // AJAX request to rename the Topic on the server
                $.post('/rename_topic_room', {current_room_name: roomToManage, new_room_name: newTopicRoomName}, function(data) {
                  if (data.success) {
                    alert('Topic renamed successfully!');
                    currentRoom = newTopicRoomName; // Update the current room name
                    updateTopicNames(); // Update the list of Topic names
                    $('#manageTopicModal').modal('hide');
                    $('#roomName').val('');
                  } else {
                    alert(data.message);
                  }
                }); 
            } else {
            alert('Please enter a new Topic name.');
            }
        });
      // Send message and get GPT response
        $('#topicForm').on('submit', function(event) {
            event.preventDefault();
            var userInput = $('#userInput').val();
            if (userInput) {
                // Display user message in topic area
                var messageID = 'msg-' + Date.now();
                $('#topicArea').append('<div class="user-message" id="' + messageID + '"><strong>You:</strong> <span class="delete-btn" data-message-id="' + messageID + '">[Delete]</span><br>'+userInput + '</div>');
                $('#userInput').val('');
                // Send message to server and get GPT response
                $.post('/send_message', {room_name: currentRoom, user_input: userInput}, function(data) {
                    if (data.success) {
                        // Display GPT response in topic area
                        var responseID = 'msg-' + Date.now();
                        var messageElem = '<div class="gpt-response" id="' + data.response_id + '"><strong class="pull-left">GPT:</strong> <span class="delete-btn pull-left" style="margin-left:15px;" data-message-id="' + data.response_id + '">[Delete]</span> <br>' + marked.parse(data.gpt_response) + '</div>';
                        $('#topicArea').append(messageElem);
                        // Scroll to the bottom of the topic area
                        $('#topicArea').scrollTop($('#topicArea')[0].scrollHeight);
                        updateBillingTotal('billingTotal');
                    } else {
                        alert(data.message);
                    }
                });
            }
        });

        // Delete message
        $(document).on('click', '.delete-btn', function() {
            var messageID = $(this).attr('data-message-id');
            $('#' + messageID).remove();
            // Send request to server to delete message
            $.post('/delete_message', {room_name: currentRoom, message_id: messageID}, function(data) {
                if (!data.success) {
                    alert(data.message);
                }
            });
        });

          // Check if SpeechRecognition is supported by the browser
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert('Speech Recognition is not supported in this browser.');
            return;
        }

        // Create a new instance of SpeechRecognition
        const recognition = new SpeechRecognition();

        // Update the textarea with the recognized words
        recognition.onresult = function(event) {
            const speechTextarea = document.getElementById('userInput');
            const transcript = Array.from(event.results)
                .map(result => result[0])
                .map(result => result.transcript)
                .join('');
            speechTextarea.value = transcript;
        };

        // Handle the microphone icon click event
        document.getElementById('microphone').addEventListener('click', function(e) {
            // Start speech recognition
            recognition.start();
            e.preventDefault()
            return false
        });
    });
</script>

</body>
</html>