<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <title>Chat with GPT</title>
    <!-- Include Bootstrap 3 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Custom styles for the chat interface -->
    <style> 


        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Prevent horizontal scrolling */
        }
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 250px;
            padding: 20px;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        .sidebar.active {
            transform: translateX(0);
        }
        .sidebar-toggle {
            position: absolute;
            top: 10px;
            left: 10px;
            cursor: pointer;
        }
        #main-content {
            transition: transform 0.3s ease-in-out;
        }
        #main-content.slide {
            transform: translateX(250px); /* Slide the content by the width of the sidebar */
            max-width: calc(100vw - 250px);
        }
        .textarea-container {
            position: relative;
        }
        .custom-textarea {
            width: 100%;
            height: 350px;
            resize: vertical;
        }
        .float-button {
            position: absolute;
            top: -30px;
            right: 14px;
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 12px 12px 0 0;
        }
        #chatNamesList > li{
            list-style: none;
            text-decoration: underline;
            margin-bottom: 5px;
            cursor:pointer;
        }
        .wrapper {
            display: flex;
        }
        .sidebar {
            flex: 1;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            margin-right: 10px;
            max-width: 236px;
        }
        .chat-container {
            flex: 2;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .chat-area {
            height: calc(100vh - 100px);
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
        .chat-container {
            position: relative;
            padding: 20px;
            height: 100vh; /* Set chat container height to 100% of viewport height */
            box-sizing: border-box; /* Include padding in the total height */
        }
        .chat-area {
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
        }
        .system-message {
            text-align: left;
            margin-bottom: 10px;
            padding:5px;
            background-color:  beige;
        }
        .user-message {
            text-align: right;
            margin-bottom: 5px;
        }
        .gpt-response {
            text-align: left;
            margin-bottom: 5px;
            background-color:  bisque;
        }
        .delete-btn {
            cursor: pointer;
            color: red;
        }
    </style>
</head>
<body>   
 <div class="wrapper">
        <!-- Sidebar with chat names -->
        <div class="sidebar active" id='sidebar'>
            <h4>
                Topics 
                <button class="plus-button btn btn-sm btn-secondary pull-right" data-toggle="modal" data-target="#createChatModal">+</button>
            </h4>
            <ul id="chatNamesList" class='mt-3'></ul>
            <!-- Input field for chat room name -->
            <hr>
        </div>
        <!-- Chat area and input field for user message -->
        <div class="chat-container slide" id="main-content">
        <i class="fa fa-bars hamburger" id="sidebarToggle"></i>


        
        <!-- Chat area and input field for user message -->
        <div class="chat-area" id="chatArea"></div>
        <form id="chatForm" style="display:none;" >
            <div class="input-group">
                <span class="input-group-btn">
                    <button  class="btn btn-secondary" id='microphone'><i class="fa fa-microphone" style="color:red"></i></button>
                </span>
                <input type="text" class="form-control" id="userInput" placeholder="Type your message here...">
                <span class="input-group-btn">
                    <input class="btn btn-primary" type="submit" value="Send"/>
                </span>
            </div>
        </form>
    </div>
</div>
<div class="modal fade" id="manageChatModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">Manage Chat Room</h4>
            </div>
            <div class="modal-body">
                <form id="roomForm" onkeydown="return event.key != 'Enter';">
                    <div class="form-group">
                        <label for="roomName">Chat Room Name</label>
                        <input type="text" class="form-control" id="roomName" placeholder="Enter chat room name...">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="renameRoomBtn">Rename</button>
                <button type="button" class="btn btn-danger" id="deleteRoomBtn">Delete</button>
            </div>
        </div>
    </div>
</div>



    
    <!-- Modal for creating a new chat room -->
<div class="modal fade" id="createChatModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">Create Chat Room</h4>
            </div>
            <div class="modal-body">
                <form id="roomForm"  onkeydown="return event.key != 'Enter';">
                    <div class="form-group">
                        <label for="create_roomName">Chat Room Name</label>
                        <input type="text" class="form-control" id="create_roomName" placeholder="Enter chat room name...">
                    </div>
                    <div class="form-group">
                        <label for="roomName">Chat Room System Prompt</label>
                        <div class="textarea-container">
                            <textarea  class="form-control custom-textarea" id="create_roomSystemMsg"></textarea>
                            <a class="float-button" data-toggle="modal" data-target="#SystemTemplateModal">Load</a>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="createRoomBtn">Create</button>
            </div>
        </div>
    </div>
</div>

    <!-- Modal for displaying the dropdown with folder contents -->
<div class="modal fade" id="SystemTemplateModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">Select File</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="fileDropdown">Select a file:</label>
                        <select class="form-control" id="fileDropdown">
                            <!-- Options will be populated using JavaScript/jQuery -->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id='selectFileBtn'>Select</button>
                </div>
            </div>
        </div>
    </div>
<script>


    marked.setOptions({ sanitize: true})

    var currentRoom = null;
    var roomToManage = null;
    

    function updateChatNames() {
        $.get('/get_chat_names', function(data) {
            if (data.success) {
                $('#chatNamesList').empty();
                data.chat_names.forEach(function(chatName) {
                    var listItem = $('<li>').text(chatName);
                    listItem.on('click', function() {
                        currentRoom = chatName;
                        updateChatHistory();  // Fetch and update chat history for the selected room
                        $('#chatForm').show();
                    });

                     listItem.on('contextmenu', function(event) {
                        event.preventDefault();  // Prevent the default context menu from appearing
                        roomToManage = chatName;  // Store the chat room to be renamed
                        $('#roomName').val(roomToManage);

                        $('#manageChatModal').modal('show');  // Show the rename modal
                    });
                    $('#chatNamesList').append(listItem);
                });
            }
        });
    }

    // Function to fetch and update chat history for the current room
    function updateChatHistory() {
        if (currentRoom) {
            $.get('/get_chat_history', {room_name: currentRoom}, function(data) {
                $('#chatArea').empty();
                if (data.success) {
                    data.chat_history.forEach(function(message) {
                        var messageElem;
                        if (message.user) {
                            messageElem = '<div class="user-message" id="' + message.id + '"><strong>You:</strong>  <span class="delete-btn pull-right" data-message-id="' + message.id + '">[Delete]</span> ' + marked.parse(message.user)+ '</div>';
                        } else if (message.gpt) {
                            messageElem = '<strong class="pull-left">GPT:</strong> <div class="gpt-response" id="' + message.id + '"><span class="delete-btn pull-left" style="margin-left:15px;" data-message-id="' + message.id + '">[Delete]</span> ' + marked.parse(message.gpt) + '</div>';
                        }else if (message.system) {
                            messageElem = '<div class="system-message" id="' + message.id + '"><strong>System:</strong> ' + marked.parse(message.system);
                        }
                        $('#chatArea').append(messageElem);
                    });
                }
            });
        }
    }


    $(document).ready(function() {
        updateChatNames();

     $('#sidebarToggle').on('click', function() {
                // Toggle the 'active' class on the sidebar
                $('#sidebar').toggleClass('active');
                // Toggle the 'slide' class on the main content
                $('#main-content').toggleClass('slide');
            });
        $('#archiveBtn').on('click', function() {
            var folderPath = $('#folderPath').val();
            if (folderPath) {
                // Send request to server to archive chats
                $.post('/archive_chats', {folder_path: folderPath}, function(data) {
                    if (data.success) {
                        // Successfully archived chats
                        alert(data.message);
                        $('#archiveModal').modal('hide');
                    } else {
                        // Failed to archive chats
                        alert(data.message);
                    }
                });
            } else {
                alert('Please enter a folder path.');
            }
        });


        $('#SystemTemplateModal').on('show.bs.modal', function() {
                // Request folder contents from the Python back-end
                $.get('/get_folder_contents', function(data) {
                    if (data.success) {
                        // Populate the dropdown options
                        var fileDropdown = $('#fileDropdown');
                        fileDropdown.empty();
                        data.folder_contents.forEach(function(file) {
                            fileDropdown.append('<option value="' + file + '">' + file + '</option>');
                        });
                    } else {
                        alert(data.message);
                    }
                });
            });
 // Load the file content and set it to the textarea
        $('#selectFileBtn').on('click', function() {
            // Get the selected filename from the dropdown
            var selectedFile = $('#fileDropdown').val();
            if (selectedFile) {
                // Request file content from the Python back-end
                $.get('/get_file_content', {filename: selectedFile}, function(data) {
                    if (data.success) {
                        // Set the file content to the textarea with ID 'create_roomSystemMsg'
                        $('#create_roomSystemMsg').val(data.file_content);
                        // Close the modal
                        $('#SystemTemplateModal').modal('hide');
                    } else {
                        alert(data.message);
                    }
                });
            } else {
                alert('Please select a file.');
            }
        });
        // Create or join chat room
          $('#createRoomBtn').on('click', function() {
            var roomName = $('#create_roomName').val();
            var systemMsg = $('#create_roomSystemMsg').val();
            if (roomName) {
                $.post('/create_chat', {room_name: roomName,roomSystemMsg:systemMsg}, function(data) {
                    if (data.success) {
                        // Chat room created successfully
                        // Perform any desired actions (e.g., show a success message, redirect to chat room)
                        updateChatNames()
                        // Close the modal
                        $('#createChatModal').modal('hide');
                        // Clear the input field
                        $('#create_roomName').val('');
                        $('#create_roomSystemMsg').val('');
                        currentRoom = roomName;
                        updateChatHistory(); 
                        $('#chatForm').show();
                    } else {
                        // Chat room creation failed
                        // Show an error message
                        alert(data.message);
                    }
                });
            } else {
                // Chat room name is empty
                // Show an error message
                alert('Please enter a chat room name.');
            }
        });
        // Delete a chat room
        $('#deleteRoomBtn').on('click', function() {
            $.post('/delete_chat', {room_name: window.roomToManage}, function(data) {
                if (data.success) {
                    // Chat room deleted successfully
                    // Perform any desired actions
                    alert(data.message);
                    updateChatNames()
                    $('#manageChatModal').modal('hide');
                    $('#roomName').val('');
                    $('#chatForm').hide();
                } else {
                    // Chat room deletion failed
                    alert(data.message);
                }
            });
        });
        $("#renameRoomBtn").click(function(){
            event.preventDefault();
            var newChatRoomName = $('#roomName').val();
            if (newChatRoomName) {
                // AJAX request to rename the chat room on the server
                $.post('/rename_chat_room', {current_room_name: roomToManage, new_room_name: newChatRoomName}, function(data) {
                  if (data.success) {
                    alert('Chat room renamed successfully!');
                    currentRoom = newChatRoomName; // Update the current room name
                    updateChatNames(); // Update the list of chat room names
                    $('#manageChatModal').modal('hide');
                    $('#roomName').val('');
                  } else {
                    alert(data.message);
                  }
                }); 
            } else {
            alert('Please enter a new chat room name.');
            }
        });
      // Send message and get GPT response
        $('#chatForm').on('submit', function(event) {
            event.preventDefault();
            var userInput = $('#userInput').val();
            if (userInput) {
                // Display user message in chat area
                var messageID = 'msg-' + Date.now();
                $('#chatArea').append('<div class="user-message" id="' + messageID + '"><strong>You:</strong> ' + userInput + ' <span class="delete-btn" data-message-id="' + messageID + '">[Delete]</span></div>');
                $('#userInput').val('');
                // Send message to server and get GPT response
                $.post('/chat', {room_name: currentRoom, user_input: userInput}, function(data) {
                    if (data.success) {
                        // Display GPT response in chat area
                        var responseID = 'msg-' + Date.now();
                        var messageElem = '<strong class="pull-left">GPT:</strong> <div class="gpt-response" id="' + data.response_id + '"><span class="delete-btn pull-left" style="margin-left:15px;" data-message-id="' + data.response_id + '">[Delete]</span> <br>' + marked.parse(data.gpt_response) + '</div>';
                        $('#chatArea').append(messageElem);
                        // Scroll to the bottom of the chat area
                        $('#chatArea').scrollTop($('#chatArea')[0].scrollHeight);
                    } else {
                        alert(data.message);
                    }
                });
            }
        });

        // Delete message
        $(document).on('click', '.delete-btn', function() {
            var messageID = $(this).attr('data-message-id');
            $('#' + messageID).remove();
            // Send request to server to delete message
            $.post('/delete_message', {room_name: currentRoom, message_id: messageID}, function(data) {
                if (!data.success) {
                    alert(data.message);
                }
            });
        });

          // Check if SpeechRecognition is supported by the browser
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert('Speech Recognition is not supported in this browser.');
            return;
        }

        // Create a new instance of SpeechRecognition
        const recognition = new SpeechRecognition();

        // Update the textarea with the recognized words
        recognition.onresult = function(event) {
            const speechTextarea = document.getElementById('userInput');
            const transcript = Array.from(event.results)
                .map(result => result[0])
                .map(result => result.transcript)
                .join('');
            speechTextarea.value = transcript;
        };

        // Handle the microphone icon click event
        document.getElementById('microphone').addEventListener('click', function(e) {
            // Start speech recognition
            recognition.start();
            e.preventDefault()
            return false
        });
    });
</script>

</body>
</html>