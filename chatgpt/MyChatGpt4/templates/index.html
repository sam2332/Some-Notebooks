<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Chat with GPT</title>
    <!-- Include Bootstrap 3 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <!-- Custom styles for the chat interface -->
    <style> 
        #chatNamesList > li{
            list-style: none;
            text-decoration: underline;
            margin-bottom: 5px;
        }
     .wrapper {
            display: flex;
            max-width: 100vw;
        }
        .sidebar {
            flex: 1;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            margin-right: 10px;
            max-width: 236px;
        }
        .chat-container {
            flex: 2;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .chat-area {
            height: calc(100vh - 83px);
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }

 .chat-container {
        position: relative;
        padding: 20px;
        height: 100vh; /* Set chat container height to 100% of viewport height */
        box-sizing: border-box; /* Include padding in the total height */
    }
    .chat-area {
        overflow-y: auto;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
    }

        .user-message {
            text-align: right;
            margin-bottom: 5px;
            white-space: pre-wrap;
        }
        .gpt-response {
            text-align: left;
            margin-bottom: 5px;
            white-space: pre-wrap;
        }
        .delete-btn {
            cursor: pointer;
            color: red;
        }
    </style>
</head>
<body>   
 <div class="wrapper">
        <!-- Sidebar with chat names -->
        <div class="sidebar">
            <h4>Chat Rooms</h4>
            <ul id="chatNamesList"></ul>
            <!-- Input field for chat room name -->
            <hr>
            <form id="roomForm">
                    <input type="text" class="form-control" id="roomName" placeholder="Enter chat room name...">
                <button class="btn btn-primary btn-block" type="submit">Create/Join Chat Room</button>
            </form>
        </div>
        <!-- Chat area and input field for user message -->
        <div class="chat-container">
        
        <!-- Chat area and input field for user message -->
        <div class="chat-area" id="chatArea"></div>
        <form id="chatForm" style="display:none;">
            <div class="input-group">
                <input type="text" class="form-control" id="userInput" placeholder="Type your message here...">
                <span class="input-group-btn">
                    <button class="btn btn-primary" type="submit">Send</button>
                </span>
            </div>
        </form>
    </div>
</div>
<script>
    var currentRoom = null;
    function updateChatNames() {
        $.get('/get_chat_names', function(data) {
            if (data.success) {
                $('#chatNamesList').empty();
                data.chat_names.forEach(function(chatName) {
                    var listItem = $('<li>').text(chatName);
                    listItem.on('click', function() {
                        currentRoom = chatName;
                        updateChatHistory();  // Fetch and update chat history for the selected room
                        $('#chatForm').show();
                    });
                    $('#chatNamesList').append(listItem);
                });
            }
        });
    }

    // Function to fetch and update chat history for the current room
    function updateChatHistory() {
        if (currentRoom) {
            $.get('/get_chat_history', {room_name: currentRoom}, function(data) {
                $('#chatArea').empty();
                if (data.success) {
                    data.chat_history.forEach(function(message) {
                        var messageElem;
                        if (message.user) {
                            messageElem = '<div class="user-message" id="' + message.id + '"><strong>You:</strong> ' + message.user + ' <span class="delete-btn" data-message-id="' + message.id + '">[Delete]</span></div>';
                        } else if (message.gpt) {
                            messageElem = '<div class="gpt-response" id="' + message.id + '"><strong>GPT:</strong> ' + message.gpt + ' <span class="delete-btn" data-message-id="' + message.id + '">[Delete]</span></div>';
                        }
                        $('#chatArea').append(messageElem);
                    });
                }
            });
        }
    }


    $(document).ready(function() {
            updateChatNames();
        // Create or join chat room
        $('#roomForm').on('submit', function(event) {
            event.preventDefault();
            var roomName = $('#roomName').val();
            if (roomName) {
                currentRoom = roomName;
                $('#chatArea').empty();
                $('#chatForm').show();
                $.post('/create_chat', {room_name: roomName}, function(data) {
                    if (!data.success) {
                        alert(data.message);
                        
                    }else{
                        $('#roomName').val('');
                        updateChatNames()
                    }
                });
            }
        });

        // Send message and get GPT response
        $('#chatForm').on('submit', function(event) {
            event.preventDefault();
            var userInput = $('#userInput').val();
            if (userInput) {
                // Display user message in chat area
                var messageID = 'msg-' + Date.now();
                $('#chatArea').append('<div class="user-message" id="' + messageID + '"><strong>You:</strong> ' + userInput + ' <span class="delete-btn" data-message-id="' + messageID + '">[Delete]</span></div>');
                $('#userInput').val('');
                // Send message to server and get GPT response
                $.post('/chat', {room_name: currentRoom, user_input: userInput}, function(data) {
                    if (data.success) {
                        // Display GPT response in chat area
                        var responseID = 'msg-' + Date.now();
                        $('#chatArea').append('<div class="gpt-response" id="' + responseID + '"><strong>GPT:</strong> ' + data.gpt_response + ' <span class="delete-btn" data-message-id="' + responseID + '">[Delete]</span></div>');
                        // Scroll to the bottom of the chat area
                        $('#chatArea').scrollTop($('#chatArea')[0].scrollHeight);
                    } else {
                        alert(data.message);
                    }
                });
            }
        });

        // Delete message
        $(document).on('click', '.delete-btn', function() {
            var messageID = $(this).attr('data-message-id');
            $('#' + messageID).remove();
            // Send request to server to delete message
            $.post('/delete_message', {room_name: currentRoom, message_id: messageID}, function(data) {
                if (!data.success) {
                    alert(data.message);
                }
            });
        });
    });
</script>

</body>
</html>